define("block_deft/socket",["exports","core/ajax","core/log","core/notification"],(function(_exports,_ajax,_log,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * Open and maintain a WebSocket to recieve messages from server.
   *
   * @package    block_deft
   * @module     block_deft/socket
   * @copyright  2022 Daniel Thies <dethies@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_log=_interopRequireDefault(_log),_notification=_interopRequireDefault(_notification);var websocket=new WebSocket("wss://deftly.us/ws"),listeners=[],_default={open:function(contextid,token){var _this=this;return websocket.onopen=function(){return websocket.send(token)},websocket.addEventListener("close",(function(e){_log.default.debug("Disconnected"),1011==e.code?(_log.default.debug("Authentication failed"),_ajax.default.call([{methodname:"block_deft_renew_token",args:{contextid:contextid},done:function(replacement){_this.reconnect(contextid,replacement.token)},fail:_notification.default.exception}])):setTimeout((function(){_this.reconnect(contextid,token)}),5e3)})),this},reconnect:function(contextid,token){_log.default.debug("Reconnecting"),websocket=new WebSocket("wss://deftly.us/ws"),this.open(contextid,token),listeners.forEach((function(callback){websocket.addEventListener("message",callback)}))},subscribe:function(callback){return websocket.addEventListener("message",callback),listeners.push(callback),this}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=socket.min.js.map