{"version":3,"file":"refresh.min.js","sources":["../src/refresh.js"],"sourcesContent":["/*\n * Refresh content when changed on the system\n *\n * @package    block_deft\n * @module     block_deft/refresh\n * @copyright  2022 Daniel Thies <dethies@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Fragment from \"core/fragment\";\nimport Notification from \"core/notification\";\nimport Socket from \"block_deft/socket\";\nimport Templates from \"core/templates\";\n\nexport default {\n\n    throttled: false,\n\n    lastupdate: 0,\n\n    /**\n     * Listen to WebSocket and refresh content\n     *\n     * @param {int} contextid Context id of block\n     * @param {string} selector Content location to replace\n     * @param {string} token Authentication token to connect service\n     * @param {int} throttle Throttle dely in ms\n     */\n    init: function(contextid, selector, token, throttle) {\n        Socket.open(contextid, token).subscribe(() => {\n            this.refresh(contextid, selector, throttle);\n        });\n    },\n\n    /**\n     * Refresh content\n     *\n     * @param {int} contextid Context id of block\n     * @param {string} selector Content location to replace\n     * @param {int} throttle Throttle dely in ms\n     */\n    refresh: function(contextid, selector, throttle) {\n        let content = document.querySelector(selector).parentNode,\n            comments = false,\n            component = content.closest('[data-component]')\n                && content.closest('[data-component]').getAttribute('data-component')\n                || 'block_deft',\n            data = {};\n        if (!content) {\n            return;\n        }\n        content.querySelectorAll('.block_deft_comments textarea').forEach((textarea) => {\n            if (\n                textarea.value != textarea.getAttribute('aria-label')\n                || !textarea.value\n            ) {\n                // User is writing a comment.\n                comments = true;\n            }\n        });\n\n        if (\n            comments\n            || (this.lastupdate + throttle > Date.now())\n            || (document.activeElement.closest(selector) && document.activeElement.closest('select'))\n        ) {\n            if (\n                !this.throttled\n                || (this.lastupdate + throttle < Date.now())\n            ) {\n                setTimeout(() => {\n                    this.refresh(contextid, selector, throttle);\n                }, Math.max(this.lastupdate + throttle - Date.now(), 40));\n                this.throttled = true;\n            }\n\n            return;\n        }\n\n        document.querySelector(selector)\n            .querySelectorAll('a.comment-link[aria-expanded=\"true\"]')\n            .forEach((opencomments) => {\n                data.opencomments = data.opencomments || [];\n                data.opencomments.push(opencomments.closest('[data-task]').getAttribute('data-task'));\n            });\n\n        Fragment.loadFragment(\n            component,\n            'content',\n            contextid,\n            {\n                jsondata: JSON.stringify(data)\n            }\n        ).done(\n            Templates.replaceNodeContents.bind(Templates, content)\n        ).fail(Notification.exception);\n\n        this.throttled = false;\n        this.lastupdate = Date.now();\n    }\n};\n"],"names":["throttled","lastupdate","init","contextid","selector","token","throttle","open","subscribe","_this","refresh","content","document","querySelector","parentNode","comments","component","closest","getAttribute","data","querySelectorAll","forEach","textarea","value","this","Date","now","activeElement","setTimeout","_this2","Math","max","opencomments","push","loadFragment","jsondata","JSON","stringify","done","Templates","replaceNodeContents","bind","fail","Notification","exception"],"mappings":";;;;;;;;wRAce,CAEXA,WAAW,EAEXC,WAAY,EAUZC,KAAM,SAASC,UAAWC,SAAUC,MAAOC,yCAChCC,KAAKJ,UAAWE,OAAOG,WAAU,WACpCC,MAAKC,QAAQP,UAAWC,SAAUE,cAW1CI,QAAS,SAASP,UAAWC,SAAUE,0BAC/BK,QAAUC,SAASC,cAAcT,UAAUU,WAC3CC,UAAW,EACXC,UAAYL,QAAQM,QAAQ,qBACrBN,QAAQM,QAAQ,oBAAoBC,aAAa,mBACjD,aACPC,KAAO,GACNR,UAGLA,QAAQS,iBAAiB,iCAAiCC,SAAQ,SAACC,UAE3DA,SAASC,OAASD,SAASJ,aAAa,eACpCI,SAASC,QAGbR,UAAW,MAKfA,UACIS,KAAKvB,WAAaK,SAAWmB,KAAKC,OAClCd,SAASe,cAAcV,QAAQb,WAAaQ,SAASe,cAAcV,QAAQ,YAG1EO,KAAKxB,WACFwB,KAAKvB,WAAaK,SAAWmB,KAAKC,SAEtCE,YAAW,WACPC,OAAKnB,QAAQP,UAAWC,SAAUE,YACnCwB,KAAKC,IAAIP,KAAKvB,WAAaK,SAAWmB,KAAKC,MAAO,UAChD1B,WAAY,IAMzBY,SAASC,cAAcT,UAClBgB,iBAAiB,wCACjBC,SAAQ,SAACW,cACNb,KAAKa,aAAeb,KAAKa,cAAgB,GACzCb,KAAKa,aAAaC,KAAKD,aAAaf,QAAQ,eAAeC,aAAa,mCAGvEgB,aACLlB,UACA,UACAb,UACA,CACIgC,SAAUC,KAAKC,UAAUlB,QAE/BmB,KACEC,mBAAUC,oBAAoBC,KAAKF,mBAAW5B,UAChD+B,KAAKC,sBAAaC,gBAEf5C,WAAY,OACZC,WAAawB,KAAKC"}