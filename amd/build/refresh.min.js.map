{"version":3,"file":"refresh.min.js","sources":["../src/refresh.js"],"sourcesContent":["/*\n * Refresh content when changed on the system\n *\n * @package    block_deft\n * @module     block_deft/refresh\n * @copyright  2022 Daniel Thies <dethies@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Fragment from \"core/fragment\";\nimport Notification from \"core/notification\";\nimport Socket from \"block_deft/socket\";\nimport Templates from \"core/templates\";\n\nexport default {\n\n    throttled: false,\n\n    lastupdate: 0,\n\n    /**\n     * Listen to WebSocket and refresh content\n     *\n     * @param {int} contextid Context id of block\n     * @param {string} selector Content location to replace\n     * @param {string} token Authentication token to connect service\n     * @param {int} throttle Throttle dely in ms\n     */\n    init: function(contextid, selector, token, throttle) {\n        Socket.open(contextid, token).subscribe(() => {\n            this.refresh(contextid, selector, throttle);\n        });\n    },\n\n    /**\n     * Refresh content\n     *\n     * @param {int} contextid Context id of block\n     * @param {string} selector Content location to replace\n     * @param {int} throttle Throttle dely in ms\n     */\n    refresh: function(contextid, selector, throttle) {\n        let content = document.querySelector(selector).parentNode;\n        if (!content)  {\n            return;\n        }\n\n        if (this.lastupdate + throttle > Date.now()) {\n            if (!this.throttled) {\n                setTimeout(() => {\n                    this.refresh(contextid, selector, throttle);\n                }, this.lastupdate + throttle - Date.now());\n                this.throttled = true;\n            }\n\n            return;\n        }\n\n        Fragment.loadFragment(\n            'block_deft',\n            'content',\n            contextid,\n            {\n            }\n        ).done(\n            Templates.replaceNodeContents.bind(Templates, content)\n        ).fail(Notification.exception);\n\n        this.throttled = false;\n        this.lastupdate = Date.now();\n    }\n};\n"],"names":["throttled","lastupdate","init","contextid","selector","token","throttle","open","subscribe","refresh","content","document","querySelector","parentNode","this","Date","now","setTimeout","loadFragment","done","Templates","replaceNodeContents","bind","fail","Notification","exception"],"mappings":";;;;;;;;wRAce,CAEXA,WAAW,EAEXC,WAAY,EAUZC,KAAM,SAASC,UAAWC,SAAUC,MAAOC,0BAChCC,KAAKJ,UAAWE,OAAOG,WAAU,UAC/BC,QAAQN,UAAWC,SAAUE,cAW1CG,QAAS,SAASN,UAAWC,SAAUE,cAC/BI,QAAUC,SAASC,cAAcR,UAAUS,WAC1CH,UAIDI,KAAKb,WAAaK,SAAWS,KAAKC,MAC7BF,KAAKd,YACNiB,YAAW,UACFR,QAAQN,UAAWC,SAAUE,YACnCQ,KAAKb,WAAaK,SAAWS,KAAKC,YAChChB,WAAY,sBAMhBkB,aACL,aACA,UACAf,UACA,IAEFgB,KACEC,mBAAUC,oBAAoBC,KAAKF,mBAAWV,UAChDa,KAAKC,sBAAaC,gBAEfzB,WAAY,OACZC,WAAac,KAAKC"}