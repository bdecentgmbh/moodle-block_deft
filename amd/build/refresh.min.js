define("block_deft/refresh",["exports","core/fragment","core/notification","block_deft/socket","core/templates"],(function(_exports,_fragment,_notification,_socket,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * Refresh content when changed on the system
   *
   * @package    block_deft
   * @module     block_deft/refresh
   * @copyright  2022 Daniel Thies <dethies@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_fragment=_interopRequireDefault(_fragment),_notification=_interopRequireDefault(_notification),_socket=_interopRequireDefault(_socket),_templates=_interopRequireDefault(_templates);var _default={throttled:!1,lastupdate:0,init:function(contextid,selector,token,throttle){var _this=this;_socket.default.open(contextid,token).subscribe((function(){_this.refresh(contextid,selector,throttle)}))},refresh:function(contextid,selector,throttle){var _this2=this,content=document.querySelector(selector).parentNode,comments=!1,component=content.closest("[data-component]")&&content.closest("[data-component]").getAttribute("data-component")||"block_deft",data={};content&&(content.querySelectorAll(".block_deft_comments textarea").forEach((function(textarea){textarea.value==textarea.getAttribute("aria-label")&&textarea.value||(comments=!0)})),comments||this.lastupdate+throttle>Date.now()||document.activeElement.closest(selector)&&document.activeElement.closest("select")?(!this.throttled||this.lastupdate+throttle<Date.now())&&(setTimeout((function(){_this2.refresh(contextid,selector,throttle)}),Math.max(this.lastupdate+throttle-Date.now(),40)),this.throttled=!0):(document.querySelector(selector).querySelectorAll('a.comment-link[aria-expanded="true"]').forEach((function(opencomments){data.opencomments=data.opencomments||[],data.opencomments.push(opencomments.closest("[data-task]").getAttribute("data-task"))})),_fragment.default.loadFragment(component,"content",contextid,{jsondata:JSON.stringify(data)}).done(_templates.default.replaceNodeContents.bind(_templates.default,content)).fail(_notification.default.exception),this.throttled=!1,this.lastupdate=Date.now()))}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=refresh.min.js.map